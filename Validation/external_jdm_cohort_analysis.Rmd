---
title: "jdm_external_cohort_analysis"
output: html_document
date: "2023-12-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = '~/Library/CloudStorage/Box-Box/')

```

```{r load libraries}
library(Seurat)
library(ggplot2)
library(svglite)
library(rlist)
library(ape)
library(matrixStats)
library(gridExtra)
library(patchwork)
library(geiger)
library(igraph)
library(dplyr)
library(tidyverse)
library(parallel)
library(reticulate)
library(wTO)
library(gplots)
library(RColorBrewer)
library(DescTools)
library(fgsea)
library(msigdbr)
library(ggridges)
library(stringr)
library(ggpubr)
```

#load functions from DECIPHER method by 
[Murrow, Rabadam et al.](https://doi.org/10.1016/j.cels.2022.06.005)
```{r source}
source('~/Library/CloudStorage/Box-Box/GRLM_Cell_Networks_Paper/Scripts/DECIPHER-seq.functions.R')
source('~/Library/CloudStorage/Box-Box/GRLM_Cell_Networks_Paper/Scripts/DECIPHER-seq.util.R')
source('~/Library/CloudStorage/Box-Box/GRLM_Cell_Networks_Paper/Scripts/boot.cor.complete.R')
source('~/Library/CloudStorage/Box-Box/GRLM_Cell_Networks_Paper/Scripts/cor.m.boot.test.R')
```

```{r load marker scores and new seurat object}
program_markers = readRDS('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/DECIPHER_outputs/program_marker_gene_lists.rds')

load('../../data/external_cohort/wnn_RNA_subcluster_obj.annotations.v1.RData')

```

```{r add patient metadata}
covariates = readxl::read_xlsx('~/Library/CloudStorage/Box-Box/jdm_pbmc_model/data/external_cohort/TCR_BCRseq1_da.xlsx')
metadata = sobj@meta.data
metadata$case_ctrl = metadata$individual
metadata$case_ctrl =  plyr::mapvalues(metadata$case_ctrl, from = covariates$study_id, to = covariates$case_control, warn_missing = T)
metadata$case_ctrl = factor(metadata$case_ctrl, levels = c('JDM', 'HC'))
sobj <- AddMetaData(sobj, metadata)
```

```{r}

saveRDS(sobj, '~/Library/CloudStorage/Box-Box/jdm_pbmc_model/data/external_cohort/wnn_RNA_subcluster_obj_annotations_covar.rds')
```

```{r subset B cells}
sobj <- readRDS('~/Library/CloudStorage/Box-Box/jdm_pbmc_model/data/external_cohort/wnn_RNA_subcluster_obj_annotations_covar.rds')
b_cells = subset(sobj, broad_label == 'B')
DimPlot(b_cells, reduction = 'umap', group.by = 'case_ctrl') + DimPlot(b_cells, reduction = 'umap')
```

```{r derive module score based on program markers}
#starting with B9 as proof of concept
library(tibble)
bmarkers_tbl <- rownames_to_column(program_markers$Bcells, var = 'gene') %>% as_tibble()
b9 <-  bmarkers_tbl[, c('gene', 'R17_Program9')]
#look at distribution of marker scores for b9

ggplot(b9, aes(sample = R17_Program9)) + stat_qq() + theme_bw()
#based on curves, thresholding genes by top 5%
```

```{r log}
#test if normal after log transformation
b9[, "log"] <- log(b9[, "R17_Program9"]) #NaNs bc of negative z scores (we don't care about those genes anyways)

ggplot(b9, aes(sample = log)) + stat_qq() + theme_bw()
```

```{r generating module scores from top 1% of markers}
b9[,"quantile"] <- percent_rank(b9[,"R17_Program9"])
b9_top <- subset(b9, subset = quantile > 0.99)
topb9_genes = b9_top[["gene"]]

b_cells <- AddModuleScore(b_cells, features = list(topb9_genes), assay = 'RNA', name = 'B9_Module', ctrl = 100) 
DefaultAssay(b_cells) <- 'RNA'
FeaturePlot(b_cells, features = c('B9_Module1'), reduction = 'umap') + DimPlot(b_cells, group.by = 'case_ctrl', reduction = 'umap')
```

```{r show module scores as pseudobulk averages}
b9_means <- b_cells@meta.data %>% group_by(individual) %>%
       mutate(B9_score = mean(B9_Module1)) 
b9_scores <- dplyr::distinct(b9_means[, c("individual", "case_ctrl", "B9_score")]) %>% drop_na
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_b9_case-control_boxplot.pdf', height = 8, width =8)
ggplot(transform(b9_scores, xjit = jitter(as.numeric(as.factor(case_ctrl)))), 
       aes(x = case_ctrl, y = B9_score, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(x = xjit)) +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
validation_programs = b9_scores
```

```{r checking CD4T1 and CD4T10 in effector T cells}
#cluster 5
cd4t_cells = subset(sobj, broad_label == 'CD4+T')
DimPlot(cd4t_cells, reduction = 'umap')
```

```{r derive module score based on program markers}
#CD4T1
library(tibble)
cd4t_markers_tbl <- rownames_to_column(program_markers$CD4Tcells, var = 'gene') %>% as_tibble()

cd4t1 <-  cd4t_markers_tbl[, c('gene', 'R17_Program1')]
#look at distribution of marker scores for CD4T1

ggplot(cd4t1, aes(sample = R17_Program1)) + stat_qq() + theme_bw()
#based on curves, would like to threshold genes by top 5%
#Seurat ModuleScore() might throw errors, so cap at 200 if necessary, so consistent with B9
```

```{r generating module score for CD4T1 from top 0.5% of markers}
cd4tmarkers_tbl <- rownames_to_column(program_markers$CD4Tcells, var = 'gene') %>% as_tibble()
cd4t1 <-  cd4tmarkers_tbl[, c('gene', 'R17_Program1')]

cd4t1[,"quantile"] <- percent_rank(cd4t1[,"R17_Program1"])
cd4t1_top <- subset(cd4t1, subset = quantile > 0.995)
topcd4t1_genes = cd4t1_top[["gene"]]

cd4t_cells <- AddModuleScore(cd4t_cells, features = list(topcd4t1_genes), assay = 'RNA', name = 'CD4T1_Module', ctrl = 100) 
DefaultAssay(cd4t_cells) <- 'RNA'
FeaturePlot(cd4t_cells, features = 'CD4T1_Module1', reduction = 'umap') + DimPlot(cd4t_cells, group.by = 'case_ctrl', reduction = 'umap')
```

```{r show module scores as pseudobulk averages}
cd4t1_means <- cd4t_cells@meta.data %>% group_by(individual) %>%
       mutate(CD4T1_score = mean(CD4T1_Module1))
cd4t1_scores <- dplyr::distinct(cd4t1_means[, c("individual", "case_ctrl", "CD4T1_score")]) %>% drop_na
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_cd4t1_case-control_boxplot.pdf', height = 8, width =8)
ggplot(transform(cd4t1_scores, xjit = jitter(as.numeric(as.factor(case_ctrl)))), 
       aes(x = case_ctrl, y = CD4T1_score, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(x = xjit)) +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
validation_programs$CD4T1_score = plyr::mapvalues(validation_programs$individual, from = cd4t1_scores$individual, to = cd4t1_scores$CD4T1_score)
```

```{r CD4T10 proxy}
cd4t10 <-  cd4t_markers_tbl[, c('gene', 'R17_Program10')]
#look at distribution of marker scores for CD4T10

ggplot(cd4t10, aes(sample = R17_Program10)) + stat_qq() + theme_bw()
#based on curves, would like to threshold genes by top 5%
#Seurat ModuleScore() might throw errors, so cap at 200 if necessary, so consistent with B9
```

```{r generating module score for CD4T10 from top 0.5% of markers}
cd4tmarkers_tbl <- rownames_to_column(program_markers$CD4Tcells, var = 'gene') %>% as_tibble()
cd4t10 <-  cd4tmarkers_tbl[, c('gene', 'R17_Program10')]

cd4t10[,"quantile"] <- percent_rank(cd4t10[,"R17_Program10"])
cd4t10_top <- subset(cd4t10, subset = quantile > 0.995)
topcd4t10_genes = cd4t10_top[["gene"]]

cd4t_cells <- AddModuleScore(cd4t_cells, features = list(topcd4t10_genes), assay = 'RNA', name = 'CD4T10_Module', ctrl = 100) 
DefaultAssay(cd4t_cells) <- 'RNA'
FeaturePlot(cd4t_cells, features = 'CD4T10_Module1', reduction = 'umap') + DimPlot(cd4t_cells, group.by = 'case_ctrl', reduction = 'umap')
```
```{r show module scores as pseudobulk averages}
cd4t10_means <- cd4t_cells@meta.data %>% group_by(individual) %>%
       mutate(CD4T10_score = mean(CD4T10_Module1))
cd4t10_scores <- dplyr::distinct(cd4t10_means[, c("individual", "case_ctrl", "CD4T10_score")]) %>% drop_na
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_cd4t10_case-control_boxplot.pdf', height = 8, width =8)
ggplot(transform(cd4t10_scores, xjit = jitter(as.numeric(as.factor(case_ctrl)))), 
       aes(x = case_ctrl, y = CD4T10_score, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(x = xjit)) +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
validation_programs$CD4T10_score = plyr::mapvalues(validation_programs$individual, from = cd4t10_scores$individual, to = cd4t10_scores$CD4T10_score)
```
###Now looking at programs from Network Module 5 that were down in JDM, and associated with regulation of cell death. We would expect these to be n.s. in cSLE because we think of cSLE as mainly autoimmune mediated (i.e. lymphocyte-mediated) so signatures in NK and myeloid wouldn't be expected
```{r}
nk_cells = subset(sobj, broad_label == 'NK')
DimPlot(nk_cells, reduction = 'umap', label = T) + DimPlot(nk_cells, reduction = 'umap', group.by= 'case_ctrl')

```

```{r derive module score based on program markers}
nkmarkers_tbl <- rownames_to_column(program_markers$NK, var = 'gene') %>% as_tibble()

nk8 <-  nkmarkers_tbl[, c('gene', 'R13_Program8')]


ggplot(nk8, aes(sample = R13_Program8)) + stat_qq() + theme_bw()
#take top 40 (?arbitrary somewhat % wise - this is top 2.5%, but within range of n genes in other module scores that take top 1% and 0.5%)
```

```{r generating module scores from top 2.5% of markers}
nk8[,"quantile"] <- percent_rank(nk8[,"R13_Program8"])
nk8_top <- subset(nk8, subset = quantile > 0.975)
topnk8_genes = nk8_top[["gene"]]

nk_cells <- AddModuleScore(nk_cells, features = list(topnk8_genes), assay = 'RNA', name = 'NK8_Module', ctrl = 100) #runs out of features to use as controls when gene list length >200
DefaultAssay(nk_cells) <- 'RNA'
FeaturePlot(nk_cells, features = c('NK8_Module1'), reduction = 'umap') + DimPlot(nk_cells, group.by = 'case_ctrl', reduction = 'umap')
```

```{r show module scores as pseudobulk averages}
nk8_means <- nk_cells@meta.data %>% group_by(individual) %>%
       mutate(nk8_score = mean(NK8_Module1))
nk8_scores <- dplyr::distinct(nk8_means[, c("individual", "case_ctrl", "nk8_score")]) %>% drop_na
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_nk8_case-control_boxplot.pdf', height = 8, width =8)
ggplot(data = nk8_scores, aes(x = case_ctrl, y = nk8_score, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
validation_programs$NK8_score = plyr::mapvalues(validation_programs$individual, from = nk8_scores$individual, to = nk8_scores$nk8_score)

```

```{r NK9 module score}
nk9 <-  nkmarkers_tbl[, c('gene', 'R13_Program9')]


ggplot(nk9, aes(sample = R13_Program9)) + stat_qq() + theme_bw()
#take top 40 (?arbitrary somewhat % wise - this is top 2.5%, but within range of n genes in other module scores that take top 1% and 0.5%)
```
```{r generating module scores from top 2.5% of markers}
nk9[,"quantile"] <- percent_rank(nk9[,"R13_Program9"])
nk9_top <- subset(nk9, subset = quantile > 0.975)
topnk9_genes = nk9_top[["gene"]]

nk_cells <- AddModuleScore(nk_cells, features = list(topnk9_genes), assay = 'RNA', name = 'NK9_Module', ctrl = 100) #runs out of features to use as controls when gene list length >200
DefaultAssay(nk_cells) <- 'RNA'
FeaturePlot(nk_cells, features = c('NK9_Module1'), reduction = 'umap') + DimPlot(nk_cells, group.by = 'case_ctrl', reduction = 'umap')
```

```{r show module scores as pseudobulk averages}
nk9_means <- nk_cells@meta.data %>% group_by(individual) %>%
       mutate(nk9_score = mean(NK9_Module1))
nk9_scores <- dplyr::distinct(nk9_means[, c("individual", "case_ctrl", "nk9_score")]) %>% drop_na
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_nk9_case-control_boxplot.pdf', height = 8, width =8)
ggplot(data = nk9_scores, aes(x = case_ctrl, y = nk9_score, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
validation_programs$NK9_score = plyr::mapvalues(validation_programs$individual, from = nk9_scores$individual, to = nk9_scores$nk9_score)

```

```{r}
myeloid_cells = subset(sobj, broad_label == 'myeloid')

DimPlot(myeloid_cells, reduction = 'umap', label = T) + DimPlot(myeloid_cells, reduction = 'umap', group.by= 'case_ctrl')
```

```{r derive module score based on program markers}

myeloidmarkers_tbl <- rownames_to_column(program_markers$Myeloid, var = 'gene') %>% as_tibble()

myeloid1 <-  myeloidmarkers_tbl[, c('gene', 'R17_Program1')]


ggplot(myeloid1, aes(sample = R17_Program1)) + stat_qq() + theme_bw()
#take top 1%, similar number of genes as Bcells
```

```{r generating module scores from top 1% of markers}
myeloid1[,"quantile"] <- percent_rank(myeloid1[,"R17_Program1"])
myeloid1_top <- subset(myeloid1, subset = quantile > 0.99)
topmyeloid1_genes = myeloid1_top[["gene"]]

myeloid_cells <- AddModuleScore(myeloid_cells, features = list(topmyeloid1_genes), assay = 'RNA', name = 'myeloid1_Module', ctrl = 100) #runs out of features to use as controls when gene list length >200
DefaultAssay(myeloid_cells) <- 'RNA'
FeaturePlot(myeloid_cells, features = c('myeloid1_Module1'), reduction = 'umap') + DimPlot(myeloid_cells, group.by = 'case_ctrl', reduction = 'umap')
```

```{r show module scores as pseudobulk averages}
myeloid1_means <- myeloid_cells@meta.data %>% group_by(individual) %>%
       mutate(myeloid1_score = mean(myeloid1_Module1))
myeloid1_scores <- dplyr::distinct(myeloid1_means[, c("individual", "case_ctrl", "myeloid1_score")]) %>% drop_na
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_myeloid1_case-control_boxplot.pdf', height = 8, width =8)
ggplot(data = myeloid1_scores, aes(x = case_ctrl, y = myeloid1_score, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
validation_programs$Myeloid1_score = plyr::mapvalues(validation_programs$individual, from = myeloid1_scores$individual, to = myeloid1_scores$myeloid1_score)

```

```{r quantile normalize validation programs for compiled plotting}
val_normalized = sapply(validation_programs[, 3:8], function(X) ecdf(X)(X))
#need to think of other ways to normalize bc ecdf not meant for negatives
saveRDS(validation_programs, '~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_programs.rds')
```

```{r distribution of compiled validation scores}
covariates = read_csv('TCRBCRseq1_dems.csv')
da_covariates = read_csv('TCR_BCRseq1_da.csv')
#need to clean up covariates files
jdm_validation_programs <- validation_programs
da_covariates$study_id <- jdm_validation_programs$individual[c(3, 2, 4, 7, 1, 5, 6)]
da_covariates[6:7, "vasglobal"] <- 0
jdm_validation_programs$da_vas = plyr::mapvalues(jdm_validation_programs$individual, from = da_covariates$study_id, to = da_covariates$vasglobal)
jdm_validation_programs[, 3:9] <- apply(jdm_validation_programs[, 3:9], as.numeric, MARGIN = 2)
saveRDS(jdm_validation_programs, '~/Library/CloudStorage/Box-Box/neely.jdm/NMF/JDM_validation_cohort/jdmval_programs.rds')
csle_validation_scores = readRDS('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/cSLE_validation_cohort/csle_cohort_validation_programs.rds')
colnames(csle_validation_scores)[2] <- 'case_ctrl'
csle_validation_scores <- csle_validation_scores[, c(1:3, 5, 4, 6:10)]
jdm_long <- gather(jdm_validation_programs, program, module_score, B9_score:Myeloid1_score, factor_key = T)
jdm_long$module_score = as.numeric(jdm_long$module_score)
csle_long <- gather(csle_validation_scores, program, module_score, B9_score:Myeloid1_score, factor_key = T)
validation_long <- rbind(jdm_long, csle_long[,c(1:2, 5:6)])
ggplot(validation_long, aes(x = module_score, color = case_ctrl)) + geom_histogram()
```
[based on discussion here:] (https://stats.stackexchange.com/questions/296990/transforming-positively-skewed-data-with-positive-and-negative-values)
#will try cube transformation 
```{r}
validation_long$cube_trans = validation_long$module_score
neg_indices = which(validation_long$cube_trans<0)
validation_long$cube_trans[neg_indices] = -validation_long$cube_trans[neg_indices]
validation_long$cube_trans = validation_long$cube_trans^(1/3)
validation_long$cube_trans[neg_indices] = -validation_long$cube_trans[neg_indices]

ggplot(validation_long, aes(x = cube_trans, color = case_ctrl)) + geom_histogram()
#makes bimodal, but not paired samples here. stick with raw data and compare parametric to non-parametric results?
```

```{r plot scores as heatmap}
module_df = rbind(jdm_validation_programs[, 1:8], csle_validation_scores[, c(1:2, 5:10)])
module_df = module_df %>% arrange(factor(case_ctrl, levels = c('cHD', 'HC', 'cSLE', 'JDM')))
pdf(file = '~/Library/CloudStorage/Box-Box/neely.jdm/NMF/DECIPHER_outputs/validation_modules_heatmap.pdf', height = 12, width = 8)
heatmap.2(as.matrix(module_df[,3:8]), trace="none",
          density.info="none", scale="none", 
          breaks=seq(-2, 2,length.out=101), 
          col=colorRampPalette(rev(brewer.pal(10, "RdBu")))(100), margins=c(12, 12), 
          Rowv = NULL, Colv = NULL, dendrogram = 'none',
          labRow = module_df$case_ctrl,
          labCol = colnames(module_df[,3:8]), key = T, revC = F)
dev.off()

```

```{r plot just JDM scores as heatmap}
module_df = jdm_validation_programs[, c(1:6, 8)]
module_df = module_df %>% arrange(factor(case_ctrl, levels = c('HC', 'JDM')))
pdf(file = '~/Library/CloudStorage/Box-Box/neely.jdm/NMF/DECIPHER_outputs/JDM_validation_modules_heatmap.pdf', height = 12, width = 8)
heatmap.2(as.matrix(module_df[,3:7]), trace="none",
          density.info="none", scale="none", 
          breaks=seq(-0.2, 0.2,length.out=101), 
          col=colorRampPalette(rev(brewer.pal(10, "RdBu")))(100), margins=c(12, 12), 
          Rowv = NULL, Colv = NULL, dendrogram = 'none',
          labRow = module_df$case_ctrl,
          labCol = colnames(module_df[,3:7]), key = T, revC = F)
dev.off()

```
```{r}
#without NK9:
heatmap.2(as.matrix(module_df[,c(3:6, 8)]), trace="none",
          density.info="none", scale="none", 
          breaks=seq(-1, 1,length.out=101), 
          col=colorRampPalette(rev(brewer.pal(10, "RdBu")))(100), margins=c(12, 12), 
          Rowv = NULL, Colv = NULL, dendrogram = 'none',
          labRow = module_df$case_ctrl,
          labCol = colnames(module_df[,c(3:6, 8)]), key = T, revC = F)

```

```{r heatmap with cube root transformation for plotting purposes}
module_df[, 3:8] <- apply(module_df[, 3:8], MARGIN = 2, simplify = F, FUN = function(x){
  neg_indices = which(x<0)
  x[neg_indices] = -x[neg_indices]
  cube_trans = x^(1/3)
  cube_trans[neg_indices] = -cube_trans[neg_indices]
  return(cube_trans)
})
pdf(file = '~/Library/CloudStorage/Box-Box/neely.jdm/NMF/DECIPHER_outputs/validation_modules_heatmap_cubetrans.pdf', height = 12, width = 8)
heatmap.2(as.matrix(module_df[,3:8]), trace="none",
          density.info="none", scale="none", 
          breaks=seq(-1, 1,length.out=101), 
          col=colorRampPalette(rev(brewer.pal(10, "RdBu")))(100), margins=c(12, 12), 
          Rowv = NULL, Colv = NULL, dendrogram = 'none',
          labRow = module_df$case_ctrl,
          labCol = colnames(module_df[,3:8]), key = T, revC = F)
dev.off()
```

```{r}
#without NK9:
heatmap.2(as.matrix(module_df[,c(3:6, 8)]), trace="none",
          density.info="none", scale="none", 
          breaks=seq(-1, 1,length.out=101), 
          col=colorRampPalette(rev(brewer.pal(10, "RdBu")))(100), margins=c(12, 12), 
          Rowv = NULL, Colv = NULL, dendrogram = 'none',
          labRow = module_df$case_ctrl,
          labCol = colnames(module_df[,c(3:6, 8)]), key = T, revC = F)

```
```{r Spearman of jdm with VAS}
jdm_long <- gather(jdm_validation_programs, program, module_score, B9_score:Myeloid1_score, factor_key = T)
ggplot(jdm_validation_programs, aes(x = jdm_validation_programs$da_vas, y = jdm_validation_programs$CD4T1_score)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman')
```
```{r Spearman of jdm with VAS}
ggplot(jdm_validation_programs, aes(x = da_vas, y = CD4T10_score)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman')
```

```{r Spearman of jdm with VAS}
ggplot(jdm_validation_programs, aes(x = jdm_validation_programs$da_vas, y = jdm_validation_programs$CD4T1_score)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman')
```

```{r spearman with jdm_og and module scores}
jdm_og_modscores <- readRDS('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/20240201_modulescoretest_jdm_discovery/jdm_og_cohort_validation_programs.rds')
jdm_og_metadata <- readxl::read_xlsx('~/Library/CloudStorage/Box-Box/neely.jdm/crosslong_02SEP21/metadata_updated.xlsx')
jdm_og_metadata$vasglobal <-  unlist(jdm_og_metadata[, 'vasglobal']) %>% as.numeric() %>% replace_na(0)
jdm_og_modscores$da_vas <- plyr::mapvalues(jdm_og_modscores$study_id_visit,from = jdm_og_metadata$study_id_visit, to=jdm_og_metadata$vasglobal)

ggplot(jdm_og_modscores, aes(x = da_vas, y = B9_score, label = study_id_visit))+
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman') +
  geom_text(hjust=0, vjust=0)
```
```{r B9 specifically different between TNJDM and inactive, active, plotting wo HCs}
jdm_only_modscores <- jdm_og_modscores %>% filter(case_control != 'HC')
ggplot(jdm_only_modscores, aes(x = da_vas, y = B9_score, label = study_id_visit))+
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman') +
  geom_text(hjust=0, vjust=0)
```

```{r}
ggplot(jdm_og_modscores, aes(x = da_vas, y = CD4T10_score, label = study_id_visit))+
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman') +
  geom_text(hjust=0, vjust=0)
```

```{r}
ggplot(jdm_og_modscores, aes(x = da_vas, y = CD4T1_score, label = study_id_visit))+
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman') +
  geom_text(hjust=0, vjust=0)
```
```{r}
jdm_val_scores = readRDS('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/jdmval_programs.rds')
ggplot(jdm_val_scores, aes(x = da_vas, y = CD4T1_score)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggpubr::stat_cor(method = 'spearman')
```

###Testing AUCell method in validation cohort
```{r}
#subset b and generate gene rankings
library(AUCell)
b <- subset(sobj, broad_label == 'B')
b_counts <- b@assays$RNA@counts
b_rankings <- AUCell_buildRankings(b_counts, nCores=2, plotStats=TRUE)
plotGeneCount(b_counts)
#can use long lists of genes - vignette shows >1000 genes in some signatures tested
```

```{r}
library(tibble)
b_markers_tbl <- rownames_to_column(program_markers$Bcells, var = 'gene') %>% as_tibble()

b9 <-  b_markers_tbl[, c('gene', 'R17_Program9')]
#look at distribution of marker scores for CD4T1

ggplot(b9, aes(sample = R17_Program9)) + stat_qq() + theme_bw()
#based on curves, take all with norm z score >0

b9[,"quantile"] <- percent_rank(b9[,"R17_Program9"])
b9 <- subset(b9, subset = quantile > 0.95)
b9_genes = b9[["gene"]]
```

```{r}
b_AUC <- AUCell_calcAUC(b9_genes, b_rankings, aucMaxRank = ceiling(0.05 * nrow(b_rankings)))

# Extract the scores and add to metadata
b_AUCell_res <- as.data.frame(t(getAUC(b_AUC)))
colnames(b_AUCell_res) <- c('B9_AUC')
b <- AddMetaData(b, b_AUCell_res)

pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_Test/jdm_val_b9_AUC_umap.pdf', height = 14, width =8)
DefaultAssay(b) <- 'RNA'
FeaturePlot(b, features = c('B9_AUC'), reduction = 'umap') + DimPlot(b, group.by = 'case_ctrl', reduction = 'umap')
dev.off()

```

```{r show B9 AUC as pseudobulk averages}
b9_means <- b@meta.data %>% group_by(individual)  %>%
       mutate(B9_AUC = mean(B9_AUC))
B9_scores <- dplyr::distinct(b9_means[, c("individual", "case_ctrl", "B9_AUC")])
B9_scores <- drop_na(B9_scores)
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_test/jdm_og_B9_AUC_boxplot.pdf', height = 8, width =8)
ggplot(transform(B9_scores, xjit = jitter(as.numeric(as.factor(case_ctrl)))), 
       aes(x = case_ctrl, y = B9_AUC, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(x = xjit)) +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
```

```{r}
cd4t = subset(sobj, broad_label == 'CD4+T')
DimPlot(cd4t, reduction = 'umap')

cd4t_counts <- cd4t@assays$RNA@counts
cd4t_rankings <- AUCell_buildRankings(cd4t_counts, nCores=2, plotStats=TRUE)
plotGeneCount(cd4t_counts)
#can use long lists of genes - vignette shows >1000 genes in some signatures tested
```

```{r}

cd4t_markers_tbl <- rownames_to_column(program_markers$CD4Tcells, var = 'gene') %>% as_tibble()

cd4t1 <-  cd4t_markers_tbl[, c('gene', 'R17_Program1')]
#look at distribution of marker scores for CD4T1

ggplot(cd4t1, aes(sample = R17_Program1)) + stat_qq() + theme_bw()

cd4t1[,"quantile"] <- percent_rank(cd4t1[,"R17_Program1"])
cd4t1 <- subset(cd4t1, subset = quantile > 0.95)
cd4t1_genes = cd4t1[["gene"]]

cd4t10 <-  cd4t_markers_tbl[, c('gene', 'R17_Program10')]
#look at distribution of marker scores for CD4T1

ggplot(cd4t10, aes(sample = R17_Program10)) + stat_qq() + theme_bw()

cd4t10[,"quantile"] <- percent_rank(cd4t10[,"R17_Program10"])
cd4t10 <- subset(cd4t10, subset = quantile > 0.95)
cd4t10_genes = cd4t10[["gene"]]
```

```{r}
cd4t_AUC <- AUCell_calcAUC(list(CD4T1 = cd4t1_genes, CD4T10 = cd4t10_genes), cd4t_rankings, aucMaxRank = ceiling(0.05 * nrow(cd4t_rankings)))

cd4t_AUCell_res <- as.data.frame(t(getAUC(cd4t_AUC)))
colnames(cd4t_AUCell_res) <- c('CD4T1_AUC', 'CD4T10_AUC')
cd4t <- AddMetaData(cd4t, cd4t_AUCell_res)

pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_test/jdm_val_cd4t1_AUC_umap.pdf', height = 14, width =8)
DefaultAssay(cd4t) <- 'RNA'
FeaturePlot(cd4t, features = c('CD4T1_AUC'), reduction = 'umap') + DimPlot(cd4t, group.by = 'case_ctrl', reduction = 'umap')
dev.off()

```

```{r}
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_test/jdm_val_cd4t10_AUC_umap.pdf', height = 14, width =8)
DefaultAssay(cd4t) <- 'RNA'
FeaturePlot(cd4t, features = c('CD4T10_AUC'), reduction = 'umap') + DimPlot(cd4t, group.by = 'case_ctrl', reduction = 'umap')
dev.off()
```

```{r show CD4T1 AUC as pseudobulk averages}
cd4t1_means <- cd4t@meta.data %>% group_by(individual)  %>%
       mutate(CD4T1_AUC = mean(CD4T1_AUC))
CD4T1_scores <- dplyr::distinct(cd4t1_means[, c("individual", "case_ctrl", "CD4T1_AUC")])
CD4T1_scores <- drop_na(CD4T1_scores)
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_test/jdm_og_CD4T1_AUC_boxplot.pdf', height = 8, width =8)
ggplot(transform(CD4T1_scores, xjit = jitter(as.numeric(as.factor(case_ctrl)))), 
       aes(x = case_ctrl, y = CD4T1_AUC, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(x = xjit)) +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
```

```{r show CD4T10 AUC as pseudobulk averages}
CD4T10_means <- cd4t@meta.data %>% group_by(individual)  %>%
       mutate(CD4T10_AUC = mean(CD4T10_AUC))
CD4T10_scores <- dplyr::distinct(CD4T10_means[, c("individual", "case_ctrl", "CD4T10_AUC")])
CD4T10_scores <- drop_na(CD4T10_scores)
pdf('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_test/jdm_og_CD4T10_AUC_boxplot.pdf', height = 8, width =8)
ggplot(transform(CD4T10_scores, xjit = jitter(as.numeric(as.factor(case_ctrl)))), 
       aes(x = case_ctrl, y = CD4T10_AUC, color = case_ctrl)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(x = xjit)) +
  theme_classic() +
  theme(legend.position = 'none') +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "HC") 
dev.off()
```
```{r}
source('proxy_AUCscore.R')

#case control: CD4T1, CD4T10, CD4T17,  B5, B14; 
#for disease activity association: IFN hubs (B7, CD4T4, CD8T7, NK13, gdT13, M17), B9, CD4T10, NK12, gdT4, CD8T11, NK8, gdT15, CD4T9, B10, NK9, CD4T17, M10, B17 

programs <- c('R17_Program1', 'R17_Program10', 'R17_Program17', 'R17_Program5', 'R17_Program14', 'R17_Program7', 'R17_Program4', 'R15_Program7', 'R13_Program13', 'R15_Program13', 'R17_Program17', 'R17_Program9', 'R13_Program12', 'R15_Program4', 'R15_Program11', 'R13_Program8', 'R15_Program15', 'R17_Program9', 'R17_Program10', 'R13_Program9', 'R17_Program17', 'R17_Program10', 'R17_Program17')
type = c('CD4+T', 'CD4+T', 'CD4+T', 'B', 'B', 'B', 'CD4+T', 'CD8+T', 'NK', 'gdT', 'myeloid', 'B', 'NK', 'gdT', 'CD8+T', 'NK', 'gdT', 'CD4+T', 'B', 'NK', 'CD4+T', 'myeloid', 'B')
nmf_type = c('CD4Tcells', 'CD4Tcells', 'CD4Tcells', 'Bcells', 'Bcells', 'Bcells', 'CD4Tcells', 'CD8Tcells', 'NK', 'gdT', 'Myeloid', 'Bcells', 'NK', 'gdT', 'CD8Tcells', 'NK', 'gdT', 'CD4Tcells', 'Bcells', 'NK', 'CD4Tcells', 'Myeloid', 'Bcells')
test_lists = proxy_AUCscore(sobj, type[1], nmf_type[1], program_markers, programs[1])

aucell_program_scores = list() 
for(i in 1:length(programs)){
  res <- proxy_AUCscore(sobj, type[i], nmf_type[i], program_markers, programs[i])
  aucell_program_scores[[i]] = res
}
names(aucell_program_scores) = paste0(nmf_type, '_', regmatches(programs,regexpr('Program[0-9]{1,2}', programs)))
aucell_program_scores_t <- mapply(function(x, y, z){
  auc_label <- paste0(y, '_', regmatches(z,regexpr('Program[0-9]{1,2}', z)))
  x <- x %>% add_column(program = auc_label)
  return(x)
}, x = aucell_program_scores, y = nmf_type, z = programs, SIMPLIFY = F)
saveRDS(aucell_program_scores, file = '~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_Results/aucell_program_scores.rds')
```

```{r markers for B cluster expressing B5 and B14 highly} 
b_cells <- subset(jdm_val, broad_label == 'B')
FeaturePlot(b_cells, features = c('CD27', 'TNFRSF13B', 'IL32'))
```
```{r}
#compiling for DA score correlations
library(tidyverse)
aucell_program_scores_t <- mapply(function(x, y, z){
  auc_label <- paste0(y, '_', regmatches(z,regexpr('Program[0-9]{1,2}', z)))
  x <- x %>% add_column(program = auc_label)
  return(x)
}, x = aucell_program_scores, y = nmf_type, z = programs, SIMPLIFY = F)
auc_res <- list_rbind(aucell_program_scores_t)
auc_res <- distinct(auc_res)
da_covariates = readxl::read_xlsx('../../data/external_cohort/TCR_BCRseq1_da.xlsx')
da_covariates[6:7, "vasglobal"] <- 0
auc_res <- auc_res %>% add_column(DA = NA)
auc_res[["DA"]] <- auc_res[["individual"]] %>% plyr::mapvalues(from = da_covariates$study_id, to = da_covariates$vasglobal)
auc_da <- auc_res %>% pivot_wider(names_from = program, values_from = AUC)
auc_da <- auc_da %>% mutate(AUC = as.numeric(AUC))
auc_da <- auc_da %>% mutate(DA = as.numeric(DA))
```

```{r}
#plotting
fmt_dcimals <- function(decimals=0){
    function(x) format(x,nsmall = decimals,scientific = FALSE)
}

#non iterative version works fine, vectorized/looped version causes problems with scale
ggplot(auc_da, aes(x = DA, y = Bcells_Program9)) +
    geom_point() +
    ggpubr::stat_cor(method = 'spearman') +
    scale_y_continuous(labels = fmt_dcimals(3))


auc_res <- auc_res %>% mutate(DA = as.numeric(DA))
auc_res <- auc_res %>% mutate(case_ctrl = as.character(case_ctrl))
auc_res <- as.data.frame(auc_res)

plot_da_scatter <- function(group, data) {
  ## check if input is valid
  if (!group %in% auc_res$program) stop("Program not listed in the data set.")
  
  ggplot(mapping = aes(x = DA, y = AUC)) +
    ## filter for manufacturer of interest
    geom_point(data = filter(data, program %in% group & case_ctrl == 'JDM'), 
               color = "#007cb1", alpha = .5, size = 4) +
    geom_point(data = filter(data, program %in% group & case_ctrl == 'HC'), 
               shape = 1, color = "grey45", size = 4) +
    ggpubr::stat_cor(data = filter(data, program %in% group), method = 'spearman') +
    scale_x_continuous(labels = fmt_dcimals(3)) +
    ## add title automatically based on subset choice
    labs(x = "Disease Activity (VASglobal)", y = group, 
         title = 'Proxy Program Correlation with Disease Activity', color = NULL)
}

for(i in unique(auc_res$program)){
  pdf(paste0('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_Results/', i, '_AUC_DA_spearman.pdf'), height = 8, width = 8)
  plot <- plot_da_scatter(i, auc_res)
  print(plot)
  dev.off()
}
```

```{r}
#plot with labels with coded paper-ids 
metadata = readxl::read_xlsx('../../data/external_cohort/TCR_BCRseq1_da.xlsx')
auc_res <- auc_res %>% add_column(paper_id = NA)
auc_res[["paper_id"]] <- auc_res[["individual"]] %>% plyr::mapvalues(from = metadata$study_id, to = metadata$paper_id)

plot_da_scatter_labels <- function(group, data) {
  ## check if input is valid
  if (!group %in% auc_res$program) stop("Program not listed in the data set.")
  
  ggplot(mapping = aes(x = DA, y = AUC, label = paper_id)) +
    geom_point(data = filter(data, program %in% group & case_ctrl == 'JDM'), 
               color = "#007cb1", alpha = .5, size = 4) +
    geom_point(data = filter(data, program %in% group & case_ctrl == 'HC'), 
               shape = 1, color = "grey45", size = 4) +
    ggpubr::stat_cor(data = filter(data, program %in% group), method = 'spearman') +
    scale_x_continuous(labels = fmt_dcimals(3)) +
    ## add title automatically based on subset choice
    labs(x = "Disease Activity (VASglobal)", y = group, 
         title = 'Proxy Program Correlation with Disease Activity', color = NULL) +
    geom_text(data = filter(data, program %in% group), nudge_x = 0.25, nudge_y = 0.001) +
    theme_bw()
}
for(i in c('CD4Tcells_Program4', 'Bcells_Program7', "NK_Program13", 'CD4Tcells_Program10', 'Bcells_Program9', 'NK_Program12')){
  pdf(paste0('~/Library/CloudStorage/Box-Box/neely.jdm/NMF/validation_analyses/JDM_validation_cohort/AUCell_Results/', i, '_AUC_DA_spearman_studyid_labelled.pdf'), height = 8, width = 10)
  plot <- plot_da_scatter_labels(i, auc_res) 
  print(plot)
  dev.off()
}
```
